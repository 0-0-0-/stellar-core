#!/bin/sh -e

case "$0" in
    */*)
	cd $(dirname $0)
	;;
esac

# Bail if not under git
git rev-parse

trap 'rm -f src/src.mk lib/medida.mk lib/lib.mk' 0

message="# This file was generated by make-mks; don't edit it by hand."

# Use only files git knows about, to avoid picking up autogenrated
# files or other random cruft.  When adding a new file foo.cpp, you
# must run "git add -N foo.cpp" before running this script.
(cd src
 echo "$message"
 echo "SRC_H_FILES" = $(git ls-files '*.h' '*.[ih]pp')
 echo "SRC_CXX_FILES" = $(git ls-files '*.cpp')
 echo "SRC_X_FILES" = $(git ls-files '*.x')
) > src/src.mk


# Hacks for shell third-party libraries without autoconf.  You may
# need to re-run this after updating submodules.

listall() {
    find "$@" -type f \
	 \( -name '*.[ch]' -o -name '*.[chi]pp' -o -name '*.cc' \) -print
}

(if test -f lib/libmedida/src/medida/medida.h; then
     echo "$message"
     echo INTERNAL_MEDIDA_FILES = $(listall lib/libmedida/src/medida)
 fi) > lib/medida.mk

(echo "$message"
 echo SOCI_FILES = $(listall lib/soci/src/backends/sqlite3 lib/soci/src/core)
 echo SOCI_PG_FILES = $(listall lib/soci/src/backends/postgresql)

 echo SQLITE3_FILES = $(listall lib/sqlite)
 echo UTIL_FILES = $(listall lib/util lib/http)
 echo ASIO_H_FILES = $(listall lib/asio/include)
 # The following does not work without boost or -DASIO_STANDALONE=1
 #echo ASIO_CXX_FILES = lib/asio/src/*.cpp
 echo ASIO_CXX_FILES = lib/asio/src/asio.cpp
 echo JSON_FILES = $(listall lib/json)

 echo MISC_H_FILES = lib/*.hpp $(listall lib/autocheck lib/cereal)
) > lib/lib.mk

trap '' 0
